<% title "Responding to #{@survey.job_title}" %>
<% highlight_tab("surveys") %>
<%= render :partial => "questions/participation_form"%>
<% content_for :initialize_js, "createMasks();observeQualificationLinks();observeUnitSelection();setupFollowups();observeResponseForQualifications();"%>
<script type="text/javascript">
function observeQualificationLinks() {
  $$('div.qualifications').each(function(elem) {
    var link = elem.select('a').first();
    var input_div = elem.select('div.field').first();
    var input = input_div.select('input').first();

    if(input.value == '') {
      input_div.hide();
      link.innerHTML = 'Add Comment';
    }
    else {
      input_div.show();
      link.innerHTML = 'Cancel';
    }

    link.observe('click', function(e) {
      field = elem.select('div.field').first().toggle();
      e.target.innerHTML = e.target.innerHTML == 'Cancel' ? 'Add Comment' : 'Cancel';
      elem.select('input').first().value = "";
      e.stop();
    });
  });
}
function observeUnitSelection() {
  var unit_selects = $$('select.units');
  unit_selects.each(function(select) {
    select.observe('change', function(e) {
      var value = e.target.value;
      var css_class = e.target.className;
      unit_selects.each(function(select) {
        if(select.value == '' && select.className == css_class) {
          select.value = value;
        }
      });
    });
  });
} function setupFollowups() {
  var root_list = $('questions');
  setupFollowupForList(root_list, null);
}

function setupFollowupForList(list, parent_questions) {
  list.childElements().each(function(item) {
    var sub_list = item.select('ol').first();
    if(sub_list) {
      // get all the inputs for this question that aren't qualifications.
      var inputs = item.childElements().first().select('input:not([id$=qualifications])');
      inputs.each(function(input){
        if(input.type == 'text') {
          input.observe('blur', function(e) {
            if(input.value === '')
              disableList(sub_list, true);
            else
              enableList(sub_list);
          });
        }
        else {
          if(inputs.length == 2) {
            input.observe('click', function(e) {
              if(parseInt(e.target.value) == 0)
                enableList(sub_list);
              else
                disableList(sub_list, true);
            });
          }
          else {
            input.observe('click', function(e) {
              enableList(sub_list);
            });
          }

        }
          
      });
      
      if(!inputs.any(function(q) {return q.checked && parseInt(q.value) == 0}))
        disableList(sub_list, false);

      setupFollowupForList(sub_list, inputs);
    }
  });
}

function enableList(list) {
  list.childElements().each(function(li) {
    var elements = li.select('div').first().select('input');
    elements.each(function(input) {
      input.removeAttribute('disabled');
    });
  });
}

function disableList(list, disableChildren) {
  list.childElements().each(function(li) {
    var elements = li.select('div').first().select('input');
    elements.each(function(input) {
      var qualifications_div = null;
      if(input.getAttribute('type').match(/checkbox|radio/)){
        input.checked = false;
        qualifications_div = input.up(1).down('div.qualifications');
      }
      else {
        input.value = '';
        if (!input.hasClassName('TextualResponse') && !input.id.include('qualifications')){
          qualifications_div = input.next('div.qualifications');
        }
      }
      if(qualifications_div != null)
        clearAndHideQualifications(qualifications_div);
      input.setAttribute('disabled', true);
    });
    var sub_list = li.select('ol').first();
    if(sub_list && disableChildren)
      disableList(sub_list, true);
  })
}

function observeResponseForQualifications(){
  $('questions').select('input').each(function(input){
    if(!input.id.include('qualifications') && !input.hasClassName('TextualResponse')) {
      if(input.getAttribute('type').match(/checkbox|radio/)){
        input.observe('click', function(e){
            input.up(1).down('div.qualifications').show();
        });
      }
      else {
        var qualifications_div = input.next('div.qualifications');
        if (input.value === ''){
          clearAndHideQualifications(qualifications_div);
        }
        else {
          qualifications_div.show();
        }
        input.observe('blur', function(e){
          if (input.value === ''){
            clearAndHideQualifications(qualifications_div);
          }
          else {
            qualifications_div.show();
          }
        });
      }
    }
  });
  //disable radio questions
  $('questions').select('div.question_container').each(function(question_div){
    var inputs = question_div.select('input:not([id$=qualifications])');
    if(question_div.select('input').first().getAttribute('type').match(/checkbox|radio/)){
      if(inputs.any(function(q){return q.checked;})) {
        question_div.down('div.qualifications').show();
      }
      else {
        clearAndHideQualifications(question_div.down('div.qualifications'));
      }
    }
  });
}

function clearAndHideQualifications(qualifications_div){
  qualifications_div.select('input').first().value = '';
  qualifications_div.select('div.field').first().hide();
  qualifications_div.select('a').first().innerHTML = 'Add Comment';
  qualifications_div.hide();
}

  function createMasks() {
    $$('input.WageResponse, input.BaseWageResponse').each(function(field) {
      <% if @participation.errors.any? then %>
        var units = field.up().adjacent('select.units').first();
      <% else %>
        var units = field.adjacent('select.units').first();
      <% end %>
      new inputMask(field, 'currency', units);
    });

    $$('input.NumericalResponse').each(function(field) {
      new inputMask(field, 'number');
    });

    $$('input.PercentResponse').each(function(field) {
      new inputMask(field, 'percent');
    });
  }
</script>
