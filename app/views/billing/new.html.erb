<% title "Billing Information for #{@survey.job_title}" %>
<% highlight_tab("surveys") %>
<div class="breadcrumbs">
  <%= image_tag 'step_1_inactive.gif' %>
  <%= image_tag 'step_2_inactive.gif' %>
  <%= image_tag 'step_3_inactive.gif' %>
  <%= image_tag 'step_4_active.gif' %>
</div>
<div id="step_container">
  <h3>Billing Information</h3>
  <p class="preview_text">
  Please enter your billing information below. The cost of a survey is <%=number_to_currency (@survey.price / 100)%> You may pay by credit card or request an invoice. You will not be billed until the survey completes successfully. 
  </p>
  <%=error_messages_for :invoice%>
  <%=flash_messages%>
  <% form_for @invoice, :url => survey_billing_path(@survey), :html => {:onSubmit => 'return validateCreditCardInfo();'} do |f| %>
    <%=f.label :organization_name, required('Company Name') %>    
    <%=f.text_field :organization_name %>
    <%=f.label :contact_name, required('Contact Name') %>    
    <%=f.text_field :contact_name, :size => 13 %>
    <%=f.label :address_line_1, required("Address Line 1") %> 
    <%=f.text_field :address_line_1 %>
    <%=f.label :address_line_2, "Address Line 2" %> 
    <%=f.text_field :address_line_2 %>
    <% form_row do %>
      <% form_box do %>
        <%=f.label :city, required('City') %> 
        <%=f.text_field :city, :size => 13 %>
      <% end %>
      <% form_box do %>
        <%= f.label :state, required('State') %> 
        <%= f.select :state, AccountsHelper::STATE_ABBR, :include_blank => true %>
      <% end %>
      <% form_box do %>
        <%=f.label :zip_code, required('Zip') %> 
        <%=f.text_field :zip_code, :size => 7 %>
      <% end %>
    <% end %>    
    <% form_row do %>
      <% form_box do %>
        <%=f.label :phone, required("Phone") %> 
        <%=f.text_field :phone, :size => 15 %>
      <% end %>
      <% form_box do %>
        <%=f.label :phone_extension, 'Ext.' %> 
        <%=f.text_field :phone_extension, :size => 5 %>
      <% end %>   
    <% end %>
    <label>How Would You Like to be Billed?</label>
    <label></label>
    <%=f.radio_button :payment_type, 'credit' %> 
    <label for="invoice_payment_type_credit" style="display: inline;">By Credit Card</label>   
    <div id="credit_card" style="padding-left: 2em; display: none;">
      <% form_row do %>
        <% form_box do %>
          <label for="credit_card_number">Credit Card Number</label>
          <%=text_field_tag :credit_card_number %>
        <% end %>
        <% form_box do %>
          <label for="expiration_month">Expiration Month/Year</label>
          <%=select_tag :expiration_month, "<option value='' selected='selected'></option>#{options_for_select(1..12)}" %>&nbsp;
          <%=select_tag :expiration_year, "<option value='' selected='selected'></option>#{options_for_select(Time.now.year..(Time.now.year + 10))}" %>
        <% end %>   
      <% end %>  
      <p><div id="credit_card_warnings" class="error_description" style="padding: 0;"></div></p>
      <label></label>
      <p>Upon successful completion of the survey, your card will be charged and you will receive a reciept via email.</p>  
    </div>
    <label></label>
    <%=f.radio_button :payment_type, 'invoice' %>
    <label for="invoice_payment_type_invoice" style="display: inline;">By Invoice</label>
    <label></label>
    <div id="invoice" style="padding-left: 2em; display: none;">
      <p>Your purchase order number is: <%=@invoice.purchase_order_number%>. Upon successful completion of the survey, you will have the opportunity to view and print the invoice.</p>
    </div>
    <p>By submitting this information, you agree that you have read and understand the <%= link_to "legal disclaimer", home_path('about'), :target => '_blank' %> and you agree to pay <%=number_to_currency (@survey.price / 100)%> upon successful completion of the survey. If you have any questions about the billing process, please <%= link_to "contact us", home_path('contact'), :target => '_blank' %>.</p>
  <div class="submit_row">
      <input id="form_submit" type="submit" value="Next &ndash; Submit Billing Information" class="next" />
      <input type="button" value='Back &ndash; Preview Survey' class="previous" onClick ="parent.location='<%=preview_survey_questions_path(@survey)%>'" />
  </div>
  <% end %>
</div>
<script type="text/javascript">

function initializeObservers() {

  $('invoice_payment_type_credit').observe('click', selectCreditCard);
  $('invoice_payment_type_invoice').observe('click', selectInvoice);
  
  if($('invoice_payment_type_credit').checked)
    $('credit_card').show();
    
  if($('invoice_payment_type_invoice').checked)
    $('invoice').show();    
 
}

function selectCreditCard() {
  $('credit_card').blindDown({'duration': 0.5});
  $('invoice').blindUp({'duration': 0.5});
}

function selectInvoice() {
  $('invoice').blindDown({'duration': 0.5})
  $('credit_card').blindUp({'duration': 0.5})
}

function validateCreditCardInfo() {

  if($('invoice_payment_type_credit').checked) {
    var errorMessages = [];
    var warningElement = $('credit_card_warnings');
  
    if($F('credit_card_number') == "") {
      errorMessages.push('Credit card number must be provided.');
      
    }
    
    if($F('expiration_month') == "") {
      errorMessages.push('Expiration month must be provided.');
      
    }
    
    if($F('expiration_year') == "") {
      errorMessages.push('Expiration year must be provided.');
      
    }
    
    if(errorMessages.size() > 0) {
      warningElement.update(errorMessages.join(' '));
      return false;
    } 
    else {
      warningElement.update();
      return true;
    }
            
  }
  
  return true;
}

</script>

<% content_for :initialize_js, "initializeObservers();"%>
